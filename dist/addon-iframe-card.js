(function(r){typeof define=="function"&&define.amd?define(r):r()})(function(){"use strict";const r=window.loadCardHelpers,m=s=>{const e=window;(e.customCards||(e.customCards=[])).push(s)},g=async(s,e)=>{let t=null;try{t=await s.callWS({type:"supervisor/api",endpoint:`/addons/${e}/info`,method:"get"})}catch{}return t},l=s=>(document.cookie=`ingress_session=${s};path=/api/hassio_ingress/;SameSite=Strict${location.protocol==="https:"?";Secure":""}`,s),_=async s=>{const e=await s.callWS({type:"supervisor/api",endpoint:"/ingress/session",method:"post"});return l(e.session)},p=async(s,e)=>{await s.callWS({type:"supervisor/api",endpoint:"/ingress/validate_session",method:"post",data:{session:e}}),l(e)};let n=window.__ingressSession;if(!n){const s=()=>({session:"",refCount:0});let e=s();n=window.__ingressSession={get session(){return e.session},get refCount(){return e.refCount},async init(t){if(!t)return!1;if(e.hass=t,e.timer===void 0){try{e.session=await _(t)}catch{return!1}e.timer===void 0&&(e.timer=setInterval(async()=>{const i=e.hass;try{await p(i,e.session)}catch{e.session=await _(i)}},6e4),e.refCount=0)}return++e.refCount,!0},fini(){e.timer!==void 0&&(--e.refCount,clearTimeout(e.finiTimer),e.finiTimer=setTimeout(()=>{delete e.finiTimer,e.refCount<=0&&e.timer!==void 0&&(clearInterval(e.timer),e=s())},6e4))}}}const c="hui-iframe-card",o="iframe",f="addon-iframe-card",C=`custom:${f}`;let d;(async()=>{let s=customElements.get(c);s===void 0&&((await r()).createCardElement({type:o}),await customElements.whenDefined(c),s=customElements.get(c)),d=s})();class w extends HTMLElement{constructor(){super(...arguments),this._disconnected=!0}static async getConfigElement(){return await d.getConfigElement()}static getStubConfig(){const e=d.getStubConfig();return e.type=C,e}connectedCallback(){delete this._disconnected,this._isIngress&&n.init(this.hass)}disconnectedCallback(){this._disconnected=!0,this._isIngress&&n.fini()}set hass(e){this._iframe?this._iframe.hass=e:(this._hass=e,this._config&&this._config.type!==o&&this._setConfig(e,this._config))}get hass(){return this._iframe?this._iframe.hass:this._hass}set layout(e){this._iframe?this._iframe.layout=e:this._layout=e}get layout(){return this._iframe?this._iframe.layout:this._layout}getCardSize(){return this._iframe?this._iframe.getCardSize():5}setConfig(e){if(!e.url)throw new Error("URL required");const t=this.hass;t?this._setConfig(t,e):this._config=e}async _setConfig(e,t){t=(()=>{const{type:a,...h}=t;return(!this._config||this._config.type!==o)&&(this._config={type:o}),Object.assign(this._config,h)})();const i=await this._fixConfig(e,t);if(i&&!await n.init(e))throw new Error("Unable to create an Ingress session");this._isIngress&&(n.fini(),delete this._isIngress),i&&(this._isIngress=!0,this._disconnected&&n.fini()),await this._updateIframe(t)}async _fixConfig(e,t){if(/^((\w+:)?\/\/[^/]+)?\/api\/hassio_ingress\/[^/]+/.test(t.url))return!0;const i=t.url.match(/^([\w-]+)(?:$|\/)(.*)/);if(!i)return!1;const[,a,h]=i,u=await g(e,a);if(!u)throw new Error(`Unable to fetch add-on info of '${a}'`);if(!u.ingress_url)throw new Error(`Add-on '${a}' does not support Ingress`);return t.url=`${u.ingress_url.replace(/\/+$/,"")}/${h}`,!0}async _updateIframe(e){let t=this._iframe;t?t.setConfig(e):(this._iframe=(await r()).createCardElement(e),t=this._iframe,this.appendChild(t),this._layout!==void 0&&(t.layout=this._layout,delete this._layout),this._hass&&(t.hass=this._hass,delete this._hass))}}customElements.define(f,w),m({type:f,name:"Ingress webpage",description:"Webpage card with addon ingress support.",documentationURL:"https://github.com/lovelylain/ha-addon-iframe-card"})});
